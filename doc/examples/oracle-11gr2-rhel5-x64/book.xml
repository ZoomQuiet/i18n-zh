<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "../../../lib/docbook/docbook4/docbookx.dtd">
<!--<!DOCTYPE book PUBLIC '-//OASIS//DTD DocBook XML V4.5//EN'
        'http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd'>-->
<article lang="en">
  <articleinfo>
    <title>Solutions of improved Oracle availability and scalability</title>
    <pubdate>2009-09-30</pubdate>
    <copyright>
      <year>2009</year>
      <holder>Elephant Talk Communications, Inc.</holder>
    </copyright>
    <authorgroup>
      <author>
        <personname>Cauchy Song</personname>
        <email>cauchy.song@elephanttalk.com</email>
      </author>
    </authorgroup>
    <revhistory>
      <revision>
        <revnumber>1.0</revnumber>
        <date>2009-9-30</date>
        <authorinitials>Cauchy Song</authorinitials>
        <revremark>First revision</revremark>
      </revision>
    </revhistory>
  </articleinfo>

  <section>
    <title>Install RHEL 5.4 x64</title>
      <section>
        <title>Pre Install</title>
        <para>x64 machine with 1G memory and 16G disk. Oracle require at least <emphasis>1G useable memory</emphasis>, so you need extra memory about 24M.</para>
        <para>RHEL 5.4 x64 install image: rhel-server-5.4-x86_64-dvd.iso (3.4 GB).</para>
      </section>

      <section>
        <title>Install RHEL 5.4 x64</title>
        <para>Please use LVM as far as possible for easy expand filesystem space, and select 'Software Development' for install oracle.</para>
      </section>

      <section>
        <title>Post Install</title>
          <section>
            <title>Check missing packages</title>
            <para>Check <ulink url="http://download.oracle.com/docs/cd/E11882_01/install.112/e10860/toc.htm#BHCGJCEA">
              <citetitle>Package Requirements</citetitle></ulink>, install missing packages like this:</para>
            <screen>rpm -ivh sysstat-7.0.2-3.el5.x86_64.rpm

rpm -ivh libaio-devel-0.3.106-3.2.i386.rpm
rpm -ivh libaio-devel-0.3.106-3.2.x86_64.rpm

rpm -ivh unixODBC-devel-2.2.11-7.1.i386.rpm unixODBC-2.2.11-7.1.i386.rpm
rpm -ivh unixODBC-devel-2.2.11-7.1.x86_64.rpm unixODBC-2.2.11-7.1.x86_64.rpm</screen>
          </section>

          <section>
            <title>Set hostname</title>
            <para>Edit <filename>/etc/sysconfig/network</filename>, set <emphasis>HOSTNAME</emphasis> to <replaceable>x64-ORA-01</replaceable>.</para>
          </section>

          <section>
            <title>Set domainname</title>
            <para>Edit <filename>/etc/sysctl.conf</filename>, set <emphasis>kernel.domainname</emphasis> to <replaceable>songdongsheng.info</replaceable>.</para>
          </section>

          <section>
            <title>Tuning kernel</title>
            <para>Edit <filename>/etc/sysctl.conf</filename>, you should update to fit your machine.</para>
            <screen>kernel.sem = 250        32000   100      128

fs.file-max = 8388608
fs.aio-max-nr = 1048576

net.ipv4.ip_local_port_range = 9000    65500

net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576</screen>
          </section>
      </section>
  </section>

  <section>
    <title>Install Oracle 11g R2</title>

    <section>
      <title>Create user oracle</title>
      <section>
        <title>Create user oracle</title>
        <screen># useradd -m -G disk oracle
# passwd oracle
</screen>
      </section>

      <section>
        <title>Update profile of oracle</title>
        <para>Edit <filename>~/.bash_profile</filename>, you should update to fit your environment.</para>
        <screen>eval "`dircolors -b`"

export ORACLE_BASE=/opt/oracle
export ORACLE_HOME=/opt/oracle/product/11.2/dg_01
export ORACLE_SID=dg01
export NLS_LANG=AMERICAN_AMERICA.AL32UTF8

export PATH=/sbin:/bin:/usr/sbin:/usr/bin:$ORACLE_HOME/bin
export LD_LIBRARY_PATH=$ORACLE_HOME/lib
</screen>
      </section>

      <section>
        <title>Update ulimit of oracle</title>
        <para>Edit <filename>/etc/pam.d/su</filename>, add one line:</para>
        <screen>session         required        pam_limits.so</screen>

        <para>Edit <filename>/etc/security/limits.conf</filename>, add 4 line:</para>
        <screen>@oracle          soft    nproc           16384
@oracle          hard    nproc           32768
@oracle          soft    nofile          65536
@oracle          hard    nofile         131072</screen>
      </section>
    </section>

    <section>
      <title>Configure VNC environment</title>
      <para>If you want to install oracle in console, please skip this section.</para>

        <section>
          <title>Configure VNC password</title>
          <screen>[oracle@x64-ORA-01 ~]$ vncpasswd
Password:
Verify:</screen>
        </section>

        <section>
          <title>Edit VNC startup file</title>

          <para>For beautiful UI, edit <filename>~/.vnc/xstartup</filename>:</para>
          <screen>gnome-session &amp;</screen>
        </section>

        <section>
          <title>Start VNC server</title>

          <screen>[oracle@x64-ORA-01 ~]$ vncserver

New 'x64-ORA-01:1 (oracle)' desktop is x64-ORA-01:1

Starting applications specified in /home/oracle/.vnc/xstartup
Log file is /home/oracle/.vnc/x64-ORA-01:1.log
</screen>
          <para>Then you can use vnc client connect the machine, enjoy it!</para>
        </section>

        <section>
          <title>Stop VNC server</title>

          <para>When you no longer need VNC server:</para>
          <screen>[oracle@x64-ORA-01 ~]$ vncserver -kill :1
Killing Xvnc process ID 2838
</screen>
        </section>
    </section>

    <section>
      <title>Install oracle</title>
      <para>Please use AL32UTF8 for default charset.</para>
    </section>
  </section>

  <section>
    <title>Configure Data Guard</title>
    <section>
      <title>Check oracle version</title>
      <screen>SQL> select * from v$version;

BANNER
--------------------------------------------------------------------------------
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
PL/SQL Release 11.2.0.1.0 - Production
CORE    11.2.0.1.0      Production
TNS for Linux: Version 11.2.0.1.0 - Production
NLSRTL Version 11.2.0.1.0 - Production
</screen>
    </section>

    <section>
      <title>Preparing the Primary Database</title>

        <section>
          <title>Enable Forced Logging</title>
          <screen>SQL> ALTER DATABASE FORCE LOGGING;</screen>
        </section>

        <section>
          <title>Configure Redo Transport Authentication</title>
          <para>Data Guard uses Oracle Net sessions to transport redo data and
            control messages between the members of a Data Guard configuration.
            These redo transport sessions are authenticated using either the
            Secure Sockets Layer (SSL) protocol or a remote login password file.</para>

          <para>If the SSL authentication requirements are not met, each member
            of a Data Guard configuration must be configured to use a remote
            login password file and every physical standby database in the
            configuration must have an up-to-date copy of the password file
            from the primary database.<screen>
[oracle@x64-ORA-01 dbs]$ cd $ORACLE_HOME/dbs
[oracle@x64-ORA-01 dbs]$ orapwd file=orapwdg01 password=machine4in force=y
</screen><note><para>Whenever you grant or revoke
            the SYSDBA or SYSOPER privileges or change the login password of
            a user who has these privileges, you must replace the password
            file at each physical or snapshot standby database in the
            configuration with a fresh copy of the password file from the
            primary database.</para></note></para>

        </section>

        <section>
          <title>Set Primary Database Initialization Parameters</title>
          <para>On the primary database, you define initialization parameters
            that control redo transport services while the database is in the
            primary role. There are additional parameters you need to add that
            control the receipt of the redo data and apply services when the
            primary database is transitioned to the standby role.</para>
          <screen>
SQL> alter system set log_archive_config='dg_config=(dg01,dg02)' scope=both;

System altered.

SQL> alter system set log_archive_dest_1='location=/opt/oracle/oradata/dg01/archive' scope=both;

System altered.

</screen>
        </section>

        <section>
          <title>Enable Archiving</title>
          <para>If archiving is not enabled, issue the following statements to
            put the primary database in ARCHIVELOG mode and enable automatic
            archiving:</para>
          <screen>SQL> SHUTDOWN IMMEDIATE;
SQL> STARTUP MOUNT;
SQL> ALTER DATABASE ARCHIVELOG;
SQL> ALTER DATABASE OPEN;
</screen>
        </section>

        <section>
          <title>Create a Backup Copy of the Primary Database Datafiles</title>
          <screen>SQL> select name from v$datafile;

NAME
--------------------------------------------------------------------------------
/opt/oracle/oradata/dg01/system01.dbf
/opt/oracle/oradata/dg01/sysaux01.dbf
/opt/oracle/oradata/dg01/undotbs01.dbf
/opt/oracle/oradata/dg01/users01.dbf

SQL> shutdown immediate
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL> exit
Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
[oracle@x64-ORA-01 ~]$ cd /opt/oracle/oradata
[oracle@x64-ORA-01 oradata]$ tar cvzf dg01.tar.gz dg01
dg01/
dg01/control01.ctl
dg01/redo01.log
dg01/redo02.log
dg01/redo03.log
dg01/sysaux01.dbf
dg01/system01.dbf
dg01/temp01.dbf
dg01/undotbs01.dbf
dg01/users01.dbf
</screen>
        </section>

        <section>
          <title>Create a Control File for the Standby Database</title>
          <screen>SQL> STARTUP MOUNT;</screen>

          <para>Then, create the control file for the standby database, and open
            the primary database to user access, as shown in the following example:</para>

          <screen>SQL> alter database create standby controlfile as '/tmp/dg02.ctl';
  SQL> alter database open;

  Database altered.

  SQL> archive log list;
  Database log mode              No Archive Mode
  Automatic archival             Disabled
  Archive destination            USE_DB_RECOVERY_FILE_DEST
  Oldest online log sequence     6
  Current log sequence           8
  </screen>
        </section>

        <section>
          <title>$ORACLE_HOME/network/admin/listener.ora</title>
          <screen>LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = x64-ORA-01.songdongsheng.info)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER = /opt/oracle</screen>
      </section>

        <section>
          <title>$ORACLE_HOME/network/admin/tnsnames.ora</title>
          <screen>DG01 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = x64-ORA-01.songdongsheng.info)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = dg01.songdongsheng.info)
    )
  )

DG02 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = x64-ORA-02.songdongsheng.info)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = dg02.songdongsheng.info)
    )
  )
</screen>
      </section>


      <section>
        <title>Prepare an Initialization Parameter File for the Standby Database</title>
        <procedure>
          <title>Prepare an Initialization Parameter File for the Standby Database</title>
          <step>
            <title>Copy the primary database parameter file to the standby database</title>
            <para>Create a text initialization parameter file (PFILE) from the server
              parameter file (SPFILE) used by the primary database; a text initialization
              parameter file can be copied to the standby location and modified. For example:</para>
            <screen>SQL> CREATE PFILE='/tmp/dg02.ora' FROM SPFILE;</screen>
            <para>Later, in Section 3.2.5, you will convert this file back to a server
              parameter file after it is modified to contain the parameter values appropriate
              for use with the physical standby database.</para>
          </step>

          <step>
            <title>Set initialization parameters on the physical standby database.</title>
            <para>Although most of the initialization parameter settings in the text
              initialization parameter file that you copied from the primary system are also
              appropriate for the physical standby database, some modifications need to be made.</para>
              <screen>...
*.audit_file_dest='/opt/oracle/admin/dg02/adump'
*.control_files='/opt/oracle/oradata/dg02/control01.ctl','/opt/oracle/recovery_area/dg02/control02.ctl'
*.db_name='dg02'
*.db_unique_name='dg02'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=dg02XDB)'

*.log_archive_start=true
*.log_archive_config='dg_config=(dg01,dg02)'
*.log_archive_dest_1='location=/opt/oracle/oradata/dg01/archive valid_for=(all_logfiles,all_roles) db_unique_name=dg01'
*.log_archive_dest_2='service=dg02 async valid_for=(online_logfiles,primary_role) db_unique_name=dg02'

*.fal_server=dg01
*.fal_client=dg02
*.db_file_name_convert='dg01','dg02'
*.log_file_name_convert='/arch1/boston/','/arch1/chicago/','/arch2/boston/','/arch2/chicago/'

*.standby_file_management=auto
...
</screen>
          </step>
        </procedure>
      </section>

      <section>
        <title>TBD</title>
      </section>


    </section>
  </section>
</article>
